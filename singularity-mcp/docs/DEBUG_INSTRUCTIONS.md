# Инструкции по отладке проблемы с project_id

## Что было сделано

1. **Добавлено логирование** в следующих местах:
   - `api.py:create_task()` - логирует входные параметры и финальный JSON запроса
   - `server.py:call_tool()` - логирует вызовы инструментов и их аргументы
   - `server.py:_execute_tool()` - специальное логирование для create_task

2. **Улучшена валидация project_id**:
   - Проверка на пустую строку
   - Проверка формата (должен начинаться с "P-")
   - Предупреждения о некорректных значениях

3. **Создан тестовый скрипт** `test_create_task.py`

## Как тестировать

### 1. Запустите тестовый скрипт напрямую

```bash
cd singularity-mcp
export SINGULARITY_API_TOKEN="ваш-токен"
python test_create_task.py
```

Скрипт:
- Получит список проектов
- Создаст задачу с первым проектом из списка
- Создаст задачу без проекта
- Покажет результаты

### 2. Проверьте логи при использовании через Claude Code

При создании задачи через Claude Code логи будут выводиться в консоль/терминал, где запущен MCP сервер.

Попробуйте создать задачу с указанием проекта:
```
Создай задачу "Тестовая задача" в проекте P-123
```

### 3. Где смотреть логи

Логи выводятся в стандартный вывод (stdout) сервера. Вы увидите сообщения вида:

```
2024-12-08 10:00:00 - singularity_mcp.server - INFO - Tool called: create_task
2024-12-08 10:00:00 - singularity_mcp.server - INFO - Executing create_task with args: {'title': 'Test', 'project_id': 'P-123'}
2024-12-08 10:00:00 - singularity_mcp.server - INFO - project_id value: 'P-123' (type: str)
2024-12-08 10:00:00 - singularity_mcp.api - INFO - Creating task with title='Test', project_id='P-123'...
2024-12-08 10:00:00 - singularity_mcp.api - INFO - Adding project_id 'P-123' to request as 'project'
2024-12-08 10:00:01 - singularity_mcp.api - INFO - Task created successfully: T-456
```

## Возможные проблемы и решения

### Проблема: project_id приходит как пустая строка
**Решение**: Добавлена проверка на пустую строку, она будет конвертироваться в None

### Проблема: project_id имеет неправильный формат
**Решение**: Добавлено предупреждение о формате, но задача всё равно создается (API может вернуть ошибку)

### Проблема: Claude Code не передает project_id
**Решение**: Проверьте логи, чтобы увидеть, какие аргументы приходят в call_tool

## Как получить список проектов для тестирования

В Claude Code:
```
Покажи все мои проекты в SingularityApp
```

Или используйте тестовый скрипт - он автоматически покажет первые 5 проектов.

## Если проблема сохраняется

1. Проверьте, что MCP сервер перезапущен после изменений
2. Убедитесь, что используется правильный формат project_id (P-XXX)
3. Посмотрите в логах, какое точно значение приходит в project_id
4. Проверьте ответ API - возможно, проект добавляется, но не отображается в интерфейсе