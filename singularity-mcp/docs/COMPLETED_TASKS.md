# Получение выполненных задач в SingularityApp

## Проблема

По умолчанию метод `list_tasks` с фильтром по датам **не возвращает выполненные задачи**, даже если они были запланированы и выполнены в указанный период.

## Причина

Когда задача выполняется в SingularityApp:
1. Устанавливается флаг `checked = 1`
2. **Автоматически** устанавливается `showInBasket = false`
3. API SingularityApp считает такие задачи **"архивированными"**
4. При запросе с `includeArchived=false` (значение по умолчанию) выполненные задачи **не возвращаются**

## Решение

Для получения выполненных задач используйте параметр `include_archived=True`:

### Пример 1: Получить ВСЕ задачи за день (выполненные и невыполненные)

```python
mcp__singularity__list_tasks(
    start_date_from="2025-12-25T00:00:00",
    start_date_to="2025-12-26T00:00:00",  # следующий день!
    include_archived=True  # ← получаем и выполненные задачи
)
```

**Результат:** вернутся все задачи (выполненные и невыполненные).

**Фильтрация после получения:**
- Выполненные: `task['checked'] == 1`
- Невыполненные: `task.get('checked') != 1` или `'checked' not in task`

### Пример 2: Получить только АКТИВНЫЕ задачи

```python
mcp__singularity__list_tasks(
    start_date_from="2025-12-25T00:00:00",
    start_date_to="2025-12-26T00:00:00",
    include_archived=False  # по умолчанию - только активные
)
```

**Результат:** вернутся только невыполненные задачи.

## Важные детали

### 1. Формат диапазона дат

**ВСЕГДА** используйте начало следующего дня вместо `23:59:59`:

✅ **Правильно:**
```python
start_date_to="2025-12-26T00:00:00"
```

❌ **Неправильно:**
```python
start_date_to="2025-12-25T23:59:59"
```

### 2. Когда использовать `include_archived`

| Сценарий | include_archived | Пояснение |
|----------|------------------|-----------|
| Вечерний обзор дня | `True` | Нужны выполненные задачи для статистики |
| Планирование завтра | `False` | Только активные задачи |
| Отчет за неделю | `True` | Нужна вся история выполнения |
| Список "что делать сегодня" | `False` | Только активные задачи |

### 3. Структура выполненной задачи

```json
{
  "id": "T-09138332-f0b0-4f33-8bc4-3142c7d9794b",
  "title": "Купи витамины",
  "checked": 1,                        // ← выполнена
  "showInBasket": false,               // ← скрыта из корзины (API считает "архивированной")
  "journalDate": "2025-12-25T10:52:18.969390Z",  // ← когда выполнена
  "start": "2025-12-25T09:00:00.000Z"  // ← когда была запланирована
}
```

## Тестирование

### Прямой запрос к API (без выполненных)

```bash
curl -s -X GET \
  "https://api.singularity-app.com/v2/task?includeArchived=false&startDateFrom=2025-12-25T00:00:00&startDateTo=2025-12-26T00:00:00" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Результат:** `{"tasks": []}` — пустой массив, если все задачи выполнены.

### Прямой запрос к API (с выполненными)

```bash
curl -s -X GET \
  "https://api.singularity-app.com/v2/task?includeArchived=true&startDateFrom=2025-12-25T00:00:00&startDateTo=2025-12-26T00:00:00" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Результат:** `{"tasks": [{...}, {...}]}` — все задачи за день.

## Рекомендации для Claude Code

При написании команд и скилов для вечернего обзора, статистики или отчетов:

1. **ВСЕГДА** используй `include_archived=True` для получения выполненных задач
2. **Фильтруй результаты** на стороне клиента по полю `checked`
3. **Используй `journalDate`** для определения времени выполнения (UTC)
4. **Конвертируй UTC → локальное время** перед отображением пользователю

### Пример кода для вечернего обзора

```python
# 1. Получить ВСЕ задачи за день
tasks = await mcp__singularity__list_tasks(
    start_date_from=f"{today}T00:00:00",
    start_date_to=f"{tomorrow}T00:00:00",
    include_archived=True  # ← ключевой параметр!
)

# 2. Разделить на выполненные и невыполненные
completed = [t for t in tasks if t.get('checked') == 1]
uncompleted = [t for t in tasks if t.get('checked') != 1]

# 3. Показать пользователю
print(f"✅ Выполнено: {len(completed)}")
for task in completed:
    # Конвертировать journalDate из UTC в локальное время
    ...

print(f"⏰ Осталось: {len(uncompleted)}")
for task in uncompleted:
    ...
```

## См. также

- [FIX_TODAY_TASKS.md](./FIX_TODAY_TASKS.md) — исправление проблемы с получением задач на сегодня
- [README.md](../README.md) — общая документация MCP сервера
