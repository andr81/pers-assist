# Интерактивные сценарии Weekly Plan

Этот файл содержит детальное описание всех интерактивных сценариев, которые должны выполняться в Фазе 2 skill weekly-plan.

---

## Сценарий 1: Просроченные задачи

### Когда активируется

Найдены задачи с `startDate < сегодня` и `archived = false`

### Алгоритм работы

1. **Получить список просроченных задач**
   ```
   list_tasks(startDateTo=<вчера>, include_archived=false)
   ```

2. **Для каждой задачи создать отдельный вопрос через AskUserQuestion**
   - Вопрос: "Что делать с задачей '[название задачи]'?"
   - Опции:
     - **"Перенести на завтра"** — обновляет `start` на завтра
     - **"Отложить на когда-нибудь"** — устанавливает `deferred=true`, убирает `start`
     - **"Выполнить сейчас"** — вызывает `complete_task(task_id)`
     - **"Оставить как есть"** — не вносит изменений
   - "Other" для custom действий

3. **Собрать ВСЕ ответы от пользователя**
   - НЕ выполнять изменения после каждого вопроса
   - Сначала спросить по всем задачам
   - Потом batch обработка

4. **Применить изменения через API**
   - Для задач с ответом "Перенести на завтра": `update_task(task_id, start=<завтра>)`
   - Для задач с ответом "Отложить на когда-нибудь": `update_task(task_id, deferred=true, start=null)`
   - Для задач с ответом "Выполнить сейчас": `complete_task(task_id)`
   - Для задач с ответом "Оставить как есть": пропустить

5. **Вывести прогресс**
   ```
   ✅ Обработано 5 просроченных задач:
   - 2 перенесены на завтра
   - 1 отложена на когда-нибудь
   - 1 выполнена
   - 1 оставлена без изменений
   ```

### Пример

```
Найдено 3 просроченные задачи:
1. "Купить продукты" (просрочена на 2 дня)
2. "Позвонить врачу" (просрочена на 1 день)
3. "Написать отчет" (просрочена на 3 дня)

→ Три отдельных AskUserQuestion
→ Собрать ответы: [завтра, когда-нибудь, выполнить]
→ Batch обновление через API:
  - update_task(task1, start=tomorrow)
  - update_task(task2, deferred=true, start=null)
  - complete_task(task3)
```

### Что НЕ делать

❌ Не спрашивать "У тебя 3 просроченные задачи, что с ними делать?" - спроси по КАЖДОЙ отдельно
❌ Не выполнять `update_task` сразу после каждого ответа - batch обработка
❌ Не пропускать шаг если просроченных задач нет - просто пометь "Нет ✅"

---

## Сценарий 2: Входящие задачи (inbox)

### Когда активируется

Найдены задачи без `projectId` через `get_inbox_tasks`

### Алгоритм работы

1. **Получить задачи без проекта**
   ```
   get_inbox_tasks(max_count=1000)
   ```

2. **Получить список проектов**
   ```
   list_projects()
   ```

3. **Для каждой задачи без проекта:**
   - Проанализировать название задачи
   - Предложить подходящий проект по контексту
   - Создать AskUserQuestion:
     - Вопрос: "В какой проект перенести задачу '[название]'?"
     - Опции: список названий проектов + "Other"
     - Рекомендация в описании первой опции: "(Рекомендуется)"

4. **Собрать ВСЕ ответы**

5. **Применить изменения**
   - Для каждой задачи: `update_task(task_id, project_id=<выбранный проект>)`

6. **Вывести прогресс**
   ```
   ✅ Распределено 4 задачи из inbox:
   - 2 → Личные задачи
   - 1 → clawbuster
   - 1 → Медицина
   ```

### Пример

```
Найдено 2 задачи в inbox:
1. "Сдать анализы" (без проекта)
2. "Исправить баг GPE-1240" (без проекта)

Список проектов:
- clawbuster (P-abc123)
- Медицина (P-def456)
- Личные задачи (P-ghi789)

→ Вопрос 1: "В какой проект перенести 'Сдать анализы'?"
  Опции: ["Медицина (Рекомендуется)", "clawbuster", "Личные задачи", "Other"]

→ Вопрос 2: "В какой проект перенести 'Исправить баг GPE-1240'?"
  Опции: ["clawbuster (Рекомендуется)", "Медицина", "Личные задачи", "Other"]

→ Собрать ответы: [Медицина, clawbuster]
→ Batch обновление:
  - update_task(task1, project_id=P-def456)
  - update_task(task2, project_id=P-abc123)
```

### Что НЕ делать

❌ Не распределять задачи автоматически без вопросов
❌ Не предлагать все проекты равнозначно - выдели рекомендованный
❌ Не пропускать задачи "без названия" - спроси по ним тоже

---

## Сценарий 3: Задачи "когда-нибудь"

### Когда активируется

Найдены задачи с `deferred=true` и без `start` date

### Алгоритм работы

1. **Получить задачи "когда-нибудь"**
   ```
   list_tasks(deferred=true, start=null)
   ```

2. **Показать список пользователю**
   ```
   Найдено 27 задач "когда-нибудь":
   - Прочитать книгу "Deep Work"
   - Настроить автобэкапы
   - Попробовать новый ресторан
   ...
   ```

3. **Спросить через AskUserQuestion:**
   - Вопрос: "Хочешь распределить какие-то из задач 'когда-нибудь' по дням этой недели?"
   - Опции:
     - "Да, выберу несколько" (открывает follow-up вопросы)
     - "Нет, оставить как есть"

4. **Если пользователь выбрал "Да":**
   - Повторный вопрос: "Какие задачи распределить?" (multiSelect: true)
   - Опции: список всех задач "когда-нибудь"

5. **Для каждой выбранной задачи спросить день:**
   - Вопрос: "На какой день назначить '[название задачи]'?"
   - Опции: ["Понедельник", "Вторник", ..., "Воскресенье", "Other"]

6. **Применить изменения**
   - `update_task(task_id, start=<выбранный день>, deferred=false)`

7. **Вывести прогресс**
   ```
   ✅ Распределено 3 задачи "когда-нибудь":
   - "Прочитать книгу" → Среда
   - "Настроить автобэкапы" → Пятница
   - "Попробовать ресторан" → Суббота
   ```

### Пример

```
Найдено 27 задач "когда-нибудь"

→ Вопрос: "Хочешь распределить?"
  Ответ: "Да"

→ Вопрос (multiSelect): "Какие задачи?"
  Ответ: ["Прочитать книгу", "Настроить автобэкапы"]

→ Вопрос: "На какой день 'Прочитать книгу'?"
  Ответ: "Среда"

→ Вопрос: "На какой день 'Настроить автобэкапы'?"
  Ответ: "Пятница"

→ Batch обновление:
  - update_task(task1, start="2025-12-25", deferred=false)
  - update_task(task2, start="2025-12-27", deferred=false)
```

### Что НЕ делать

❌ Не распределять ВСЕ задачи "когда-нибудь" - только выбранные пользователем
❌ Не предлагать конкретные дни автоматически - пользователь сам решает
❌ Не забывать устанавливать `deferred=false` при назначении даты

---

## Сценарий 4: Дубликаты задач

### Когда активируется

При анализе проектов (Шаг 4.3) найдены задачи с похожими названиями

### Алгоритм работы

1. **При получении задач проекта анализировать названия**
   - Искать схожие строки (levenshtein distance, fuzzy matching)
   - Группировать потенциальные дубликаты

2. **Если найдены потенциальные дубликаты:**
   ```
   Найдены потенциальные дубликаты в проекте "clawbuster":
   Группа 1:
   - "Исправить баг GPE-1222" (создана 10.12.2025)
   - "Фикс бага GPE-1222" (создана 15.12.2025)

   Группа 2:
   - "Код-ревью для PR#123"
   - "Сделать код-ревью PR#123"
   ```

3. **Спросить через AskUserQuestion для каждой группы:**
   - Вопрос: "Объединить задачи '[название1]' и '[название2]'?"
   - Опции:
     - "Да, объединить" (какую оставить)
     - "Нет, это разные задачи"

4. **Если пользователь выбрал "Да":**
   - Follow-up: "Какую задачу оставить?"
   - Опции: [название1, название2]

5. **Применить изменения**
   - Оставить выбранную задачу
   - Удалить другую через `delete_task` или `archive_task`

6. **Вывести прогресс**
   ```
   ✅ Объединено 2 группы дубликатов (сэкономлено 2 задачи)
   ```

### Пример

```
Группа дубликатов:
- Task1: "Исправить баг GPE-1222"
- Task2: "Фикс бага GPE-1222"

→ Вопрос: "Объединить эти задачи?"
  Ответ: "Да"

→ Вопрос: "Какую оставить?"
  Опции: ["Исправить баг GPE-1222 (Рекомендуется - создана раньше)", "Фикс бага GPE-1222"]
  Ответ: "Исправить баг GPE-1222"

→ Применить:
  - archive_task(task2_id)
```

### Что НЕ делать

❌ Не объединять автоматически - всегда спрашивать
❌ Не считать задачи дубликатами если они из разных проектов
❌ Не удалять обе задачи - оставить выбранную пользователем

---

## Общие правила для всех сценариев

### 1. Батчинг (Batch Processing)

✅ **Правильно:**
```
Спросить по задаче 1
Спросить по задаче 2
Спросить по задаче 3
Собрать ВСЕ ответы
Применить изменения для всех задач
```

❌ **Неправильно:**
```
Спросить по задаче 1
Применить изменение для задачи 1
Спросить по задаче 2
Применить изменение для задачи 2
...
```

### 2. Использование AskUserQuestion

- Всегда указывай `multiSelect: false` (по умолчанию) для выбора одного варианта
- Используй `multiSelect: true` только когда нужно выбрать несколько (например, список задач)
- Добавляй "(Рекомендуется)" к опции, которую предлагаешь
- Всегда предоставляй опцию "Other" через систему (она добавляется автоматически)

### 3. Прогресс и feedback

После каждого сценария выводи результат:
```
✅ [Действие] выполнено:
- X задач обработано
- Y изменений применено
```

### 4. Обработка ошибок

Если API вернул ошибку:
- НЕ молча пропускать
- Сообщить пользователю: "⚠️ Не удалось обновить задачу '[название]': [причина]"
- Продолжить обработку остальных задач

---

## Приоритет выполнения

Фаза 2 выполняется в строгом порядке:
1. Просроченные задачи (самое важное - разгрести хвосты)
2. Входящие задачи (разобрать inbox)
3. Задачи "когда-нибудь" (распределить по желанию)
4. Дубликаты (опционально, при обнаружении)

**Нельзя переходить к Фазе 4 (формирование отчета) пока не завершены шаги 1-3!**
